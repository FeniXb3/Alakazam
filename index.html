<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>

        <button id="redraw">Redraw</button>
        <button id="clear">Clear</button>
        Here is one mermaid diagram:
        <div id="output"></div>

        
        <div id="flowchart-code-preview" rows="10" cols="60"></div>

        <script type="module">
            import {Flowchart, Node} from './alakazam.js';

            const flowchart = new Flowchart();
            flowchart.prepare();
            const redrawButton = document.getElementById('redraw');
            const clearButton = document.getElementById('clear');
            const output = document.getElementById('output');
            const previewContainer = document.getElementById('flowchart-code-preview');

            redrawButton.addEventListener('click', () =>{
                const flowchartCode = flowchart.generateCode();
                previewContainer.innerText = flowchartCode;
                mermaid.render('theGraph', flowchartCode, function(svgCode) {
                    output.innerHTML = svgCode;
                });
            });

            clearButton.addEventListener('click', () =>{
                previewContainer.innerText = ''; 
                output.innerHTML = '';
            });

            let startingNodeElement;
            let finishingNodeElement;
            output.addEventListener('mousedown', (event) => {
                console.log(event.target);
                const shouldReattachConnected = !event.getModifierState('Control');
                // const altPressed = event.getModifierState('Alt');
                // const shiftPressed = event.getModifierState('Shift');

                startingNodeElement = event.target.closest('.node');
                if (!startingNodeElement || !startingNodeElement.classList.contains('node')) {
                    return;
                }
            });
            output.addEventListener('mouseup', (event) => {
                console.log(event.target);
                const shouldReattachConnected = !event.getModifierState('Control');
                // const altPressed = event.getModifierState('Alt');
                // const shiftPressed = event.getModifierState('Shift');

                finishingNodeElement = event.target.closest('.node');
                if (!finishingNodeElement || !startingNodeElement || !finishingNodeElement.classList.contains('node')) {
                    return;
                }

                if (finishingNodeElement == startingNodeElement) {

                    const availableTypes = Object.keys(Node.typeSigns);
                    console.log(availableTypes);
                    const availableTypesText = availableTypes.reduce((prev, curr) => `${prev}/${curr}`);
                    const nodeDescription = prompt("Node description");
                    let nodeType; 
                    while(!availableTypes.includes(nodeType)) {
                        nodeType = prompt(`Node type (${availableTypesText})`);
                    }
                    const connectionDescription = prompt("Connection description");
                    flowchart.addNodeTo(finishingNodeElement.id, shouldReattachConnected, nodeDescription, nodeType, connectionDescription);
                }
                else {
                    const connectionDescription = prompt("Connection description");
                    flowchart.connectNodes(startingNodeElement.id, finishingNodeElement.id, shouldReattachConnected, connectionDescription);
                }

                redrawButton.click();
            });

            redrawButton.click();
            
        </script>
       
    </body>
</html>